name: Build For S6P & Upload AMR

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # 每天0点自动触发

env:
  TOOLCHAIN_URL: https://github.com/penosext/Cloudpan/releases/download/toolchains/armv7-eabihf--glibc--stable-2018.11-1.tar.bz2
  VERSIONINFO_URL: https://github.com/penosext/Cloudpan/releases/download/PenS6Pro/S6PversionInfo.tar.gz
  DEVICE: s6p

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: ''

      - name: Install dependencies & toolchain
        run: |
          npm install -g pnpm@latest-10
          pnpm install --verbose -C ./ui
          mkdir -p ./jsapi/toolchains
          wget -q ${{ env.TOOLCHAIN_URL }} -O ./jsapi/toolchains/armv7-eabihf--glibc--stable-2018.11-1.tar.bz2
          tar -xjf ./jsapi/toolchains/armv7-eabihf--glibc--stable-2018.11-1.tar.bz2 -C ./jsapi/toolchains
          wget -q ${{ env.VERSIONINFO_URL }}
          tar -xf S6PversionInfo.tar.gz -C ./jsapi

      - name: Build
        run: |
          sed -i "s/const DEVICE_MODEL = '.*';/const DEVICE_MODEL = '\${DEVICE}';/" ./ui/src/pages/update/update.ts
          cd ./ui
          sed -i "s/commonjs(),/commonjs(),require('@rollup\/plugin-typescript')(),/g" ./node_modules/aiot-vue-cli/src/libs/rollup.config.js
          sed -i "s/compiler.parseComponent(content, { pad: 'line' })/compiler.parse(content, { pad: 'line' }).descriptor/g" ./node_modules/aiot-vue-cli/web-loaders/falcon-vue-loader/lib/parser.js
          sed -i "s/path.resolve(__dirname, '.\/vue\/packages\/vue-template-compiler\/index.js')/'@vue\/compiler-sfc'/g" ./node_modules/aiot-vue-cli/cli-libs/index.js
          sed -i "s/compiler.parseComponent(content, { pad: true })/compiler.parse(content, { pad: true }).descriptor/g" ./node_modules/aiot-vue-cli/src/libs/parser.js
          sed -i "s/compiler.compile/compiler.compileTemplate/g" ./node_modules/aiot-vue-cli/web-loaders/falcon-vue-loader/lib/template-compiler/index.js
          sed -i "s/const replaceValues = {}/const replaceValues = { 'defineComponent': '' }/g" ./node_modules/aiot-vue-cli/src/libs/rollup.config.js
          cd ..
          sed -i '/project(/a\set(CMAKE_DEPEND_INFO_SKIP 1)\nset(CMAKE_LINK_DEPENDS_USE_LINKER 0)' ./jsapi/CMakeLists.txt
          ./tools/build.sh

      - name: Collect AMR files
        run: |
          find . -type f -iname '*.amr' > amr_files.txt || true
          echo "Found $(wc -l < amr_files.txt) .amr files"
          cat amr_files.txt

      - name: Upload AMR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: amr-files
          path: './ui/*.amr'
          if-no-files-found: ignore
          retention-days: 30
